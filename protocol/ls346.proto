# Protocol file for Lakeshore 346
# Osprey DCS, January 2026
#
# Based on the protocol for Lakeshore 336

ReplyTimeout = 4000;
LockTimeout = 40000;

# Device ID
getIDN {
    out "*IDN?;*OPC?";
    in "%*[^,],%[^,],%(\$1SERIAL_RBV)[^,],%(\$1FIRMWARE_RBV)[^;];1";
}

# Optional Cards
getCARDS {
    out "CARDS?;*OPC?";
    in "%d,%(\$1F:TYPE_RBV.RVAL)d,%(\$1G:TYPE_RBV.RVAL)d,%(\$1H:TYPE_RBV.RVAL)d;1";
}

# Read the heater status for outputs
getHTR {
    out "HTR? \$1;*OPC?";
    in "%f;1";
}

# Setpoint for the given output
getSETP {
    out "SETP? \$1;*OPC?";
    in "%f;1";
}

setSETP {
    out "SETP \$1,%f;*OPC?";
    in "1";
    @init { getSETP; }
}

# Read all temperatures in Kelvin into a waveform
getKRDGALL {
    out "KRDG? ALL";
    separator=",";
    in "%f";
}

# Read all sensor raw readings into a waveform
getSRDGALL {
    out "SRDG? ALL";
    separator=",";
    in "%f";
}

# Range parameter (power range) for the given output
getRANGE {
    out "RANGE? \$1;*OPC?";
    in "%d;1";
}

setRANGE {
    out "RANGE \$1,%d;*OPC?";
    in "1";
    @init { getRANGE; }
}

# Ramp parameters
getRAMP {
    out "RAMP? \$1;*OPC?";
    in "%(\$2:RAMPST_RBV)d,%f;1";
    @init {
        out "RAMP? \$1;*OPC?";
        in "%(\$2:RAMPST)d,%(\$2:RAMP)f;1";
    }
}

setRAMP       { out "RAMP \$1,%(\$2:RAMPST_RBV.VAL)d,%f;*OPC?"; in "1"; }
setRAMPSTATUS { out "RAMP \$1,%d,%(\$2:RAMP_RBV.VAL)f;*OPC?";   in "1"; }

# Manual Output
getMOUT {
    out "MOUT? \$1;*OPC?";
    in "%f;1";
}

setMOUT {
    out "MOUT \$1,%f;*OPC?";
    in "1";
    @init { getMOUT; }
}

# PID
getPID {
    out "PID? \$1;*OPC?";
    in "%f,%(\$2:I_RBV)f,%(\$2:D_RBV)f;1";
    @init { out "PID? \$1;*OPC?"; in "%(\$2:P)f,%(\$2:I)f,%(\$2:D)f;1"; }
}

setP { out "PID \$1,%f,%(\$2:I_RBV.VAL)f,%(\$2:D_RBV.VAL)f;*OPC?"; in "1"; }
setI { out "PID \$1,%(\$2:P_RBV.VAL)f,%f,%(\$2:D_RBV.VAL)f;*OPC?"; in "1"; }
setD { out "PID \$1,%(\$2:P_RBV.VAL)f,%(\$2:I_RBV.VAL)f,%f;*OPC?"; in "1"; }

# Outmode
getOM {
    out "OUTMODE? \$1;*OPC?";
    in "%d,%(\$2:OMI_RBV)[^,],%(\$2:OMP_RBV)d,%(\$2:OMW_RBV)d;1";
    @init {
        out "OUTMODE? \$1;*OPC?";
        in "%(\$2:OMM)d,%(\$2:OMI)[^,],%(\$2:OMP)d,%(\$2:OMW)d;1";
    }
}

setOM  { out "OUTMODE \$1,%d,%(\$2:OMI_RBV.VAL)s,%(\$2:OMP_RBV.RVAL)d,%(\$2:OMW_RBV.RVAL)d;*OPC?"; in "1"; }
setOMI { out "OUTMODE \$1,%(\$2:OMM_RBV.RVAL)d,%s,%(\$2:OMP_RBV.RVAL)d,%(\$2:OMW_RBV.RVAL)d;*OPC?"; in "1"; }
setOMP { out "OUTMODE \$1,%(\$2:OMM_RBV.RVAL)d,%(\$2:OMI_RBV.VAL)s,%d,%(\$2:OMW_RBV.RVAL)d;*OPC?"; in "1"; }
setOMW { out "OUTMODE \$1,%(\$2:OMM_RBV.RVAL)d,%(\$2:OMI_RBV.VAL)s,%(\$2:OMP_RBV.RVAL)d,%d;*OPC?"; in "1"; }

getTUNEST {
    out "TUNEST?;*OPC?";
    in "%[^;];1";
}

# Read the tuning status success param
getTUNESTSUCCESS {
    out "TUNEST?*OPC?";
    in "%*d,%*d,%d,%*d;1";
}

# Input sensor name
getINNAME {
    out "INNAME? \$1;*OPC?";
    in "\"%[^\"]\";1";
    @mismatch { in "1"; }
}

setINNAME {
    out "INNAME \$1,\"%s\";*OPC?";
    in "1";
    @init { getINNAME; }
}

# Input Reading Operation Status Query
getRDGOPR {
    out "RDGOPR? \$1;*OPC?";
    in "%d;1";
}

# Alarm Parameters
getALARM {
    out "ALARM? \$1;*OPC?";
    in "%d,%(\$2_HIGHVAL_RBV)f,%(\$2_LOWVAL_RBV)f,%(\$2_DB_RBV)f,%(\$2_LE_RBV)d,%(\$2_AU_RBV)d,%(\$2_VIS_RBV)d;1";
    @mismatch { in "1"; }
    @init {
        out "ALARM? \$1;*OPC?";
        in "%(\$2_ONOFF)d,%(\$2_HIGHVAL)f,%(\$2_LOWVAL)f,%(\$2_DB)f,%(\$2_LE)d,%(\$2_AU)d,%(\$2_VIS)d;1";
    }
}

setALARM_ONOFF   { out "ALARM \$1,%d,%(\$2_HIGHVAL_RBV.VAL)f,%(\$2_LOWVAL_RBV.VAL)f,%(\$2_DB_RBV.VAL)f,%(\$2_LE_RBV.VAL)d,%(\$2_AU_RBV.VAL)d,%(\$2_VIS_RBV.VAL)d;*OPC?"; in "1"; }
setALARM_HIGHVAL { out "ALARM \$1,%(\$2_ONOFF_RBV)d,%f,%(\$2_LOWVAL_RBV.VAL)f,%(\$2_DB_RBV.VAL)f,%(\$2_LE_RBV.VAL)d,%(\$2_AU_RBV.VAL)d,%(\$2_VIS_RBV.VAL)d;*OPC?";       in "1"; }
setALARM_LOWVAL  { out "ALARM \$1,%(\$2_ONOFF_RBV)d,%(\$2_HIGHVAL_RBV.VAL)f,%f,%(\$2_DB_RBV.VAL)f,%(\$2_LE_RBV.VAL)d,%(\$2_AU_RBV.VAL)d,%(\$2_VIS_RBV.VAL)d;*OPC?";      in "1"; }
setALARM_DB      { out "ALARM \$1,%(\$2_ONOFF_RBV)d,%(\$2_HIGHVAL_RBV.VAL)f,%(\$2_LOWVAL_RBV.VAL)f,%f,%(\$2_LE_RBV.VAL)d,%(\$2_AU_RBV.VAL)d,%(\$2_VIS_RBV.VAL)d;*OPC?";  in "1"; }
setALARM_LE      { out "ALARM \$1,%(\$2_ONOFF_RBV)d,%(\$2_HIGHVAL_RBV.VAL)f,%(\$2_LOWVAL_RBV.VAL)f,%(\$2_DB_RBV.VAL)f,%d,%(\$2_AU_RBV.VAL)d,%(\$2_VIS_RBV.VAL)d;*OPC?";  in "1"; }
setALARM_AU      { out "ALARM \$1,%(\$2_ONOFF_RBV)d,%(\$2_HIGHVAL_RBV.VAL)f,%(\$2_LOWVAL_RBV.VAL)f,%(\$2_DB_RBV.VAL)f,%(\$2_LE_RBV.VAL)d,%d,%(\$2_VIS_RBV.VAL)d;*OPC?";  in "1"; }
setALARM_VIS     { out "ALARM \$1,%(\$2_ONOFF_RBV)d,%(\$2_HIGHVAL_RBV.VAL)f,%(\$2_LOWVAL_RBV.VAL)f,%(\$2_DB_RBV.VAL)f,%(\$2_LE_RBV.VAL)d,%(\$2_AU_RBV.VAL)d,%d;*OPC?";   in "1"; }

# Read the input reading status
getRDGST {
    out "RDGST? \$1;*OPC?";
    in "%d;1"
}

# Read the heater status for given output
getHTRST {
    out "HTRST? \$1;*OPC?";
    in "%d;1"
}

#  Input curve number
getINCRV {
    out "INCRV? \$1;*OPC?";
    in "%d;1";
    @mismatch { in "1"; }
}

setINCRV {
    out "INCRV \$1,%d;*OPC?";
    in "1";
    @init { getINCRV; }
}

# Read the input type params
getINTYPE {
    out "INTYPE? \$1;*OPC?";
    in "%(\$2_S_RBV)d,%(\$2_AR_RBV)d,%(\$2_R_RBV)d,%(\$2_C_RBV)d,%(\$2_U_RBV)d;1";
    @mismatch { in "1"; }
}

# Start the auto tune process.
setATUNE {
    out "ATUNE \$1,%(\$2.VAL)d;*OPC?";
    in "1";
}

getTLIMIT {
    out "TLIMIT? \$1;*OPC?";
    in "%f;1";
    @mismatch { in "1"; }
}

setTLIMIT {
    out "TLIMIT $1, %f;*OPC?";
    in "1";
    @init { getTLIMIT; }
}

getFILTER {
    out "FILTER? \$1;*OPC?";
    in "%d,%(\$2_NPTS_RBV)d,%(\$2_WND_RBV)d;1";
    @init {
        out "FILTER? \$1;*OPC?";
        in "%(\$2_EN)d,%(\$2_NPTS)d,%(\$2_WND)d;1";
    }
}

setFILTER_EN   { out "FILTER \$1,%d,%(\$2_NPTS_RBV)d,%(\$2_WND_RBV)d;*OPC?"; in "1"; }
setFILTER_NPTS { out "FILTER \$1,%(\$2_EN_RBV)d,%d,%(\$2_WND_RBV)d;*OPC?";   in "1"; }
setFILTER_WND  { out "FILTER \$1,%(\$2_EN_RBV)d,%(\$2_NPTS_RBV)d,%d;*OPC?";  in "1"; }

# Reset all alarms
cmdALMRST {
    out "ALMRST;*OPC?";
    in "1";
}

# Minimum/Maximum

getMDAT {
    out "MDAT? \$1;*OPC?";
    in "%f,%(\$2:MDATMAX_RBV)f;1";
}

cmdMNMXRST {
    out "MNMXRST \$1;*OPC?";
    in "1";
}

# Digital I/O

getRELAY {
    out "RELAY? \$1;*OPC?";
    in "%d,%(\$2_INP_RBV)[^,],%(\$2_COND_RBV)d;1";
}

setRELAY {
    out "RELAY \$1,%(\$2_MODE)d,%(\$2_INP)s,%(\$2_COND)d;*OPC?";
    in "1";
    @init {
        out "RELAY? \$1;*OPC?";
        in "%(\$2_MODE)d,%(\$2_INP)[^,],%(\$2_COND)d;1";
    }
}

getRELAYST {
    out "RELAYST? \$1;*OPC?";
    in "%d;1";
}

getDIGIN {
    out "DIGIN?";
    separator = ",";
    in "%d";
}

# Curve
getCRVHDR {
    out "CRVHDR? %(\$1:NUM.VAL)d;*OPC?";
    in "\"%(\$1:NAME_RBV)[^\"]\",\"%(\$1:SERIAL_RBV)[^\"]\",%(\$1:FORMAT_RBV.RVAL)d,%(\$1:LIMIT_RBV)f,%(\$1:COEFF_RBV.RVAL)d;1";
}

getCRVNUMPTS {
    out "CRVNUMPTS? %(\$1:NUM.VAL)d;*OPC?";
    in "%d;1";
}

# Heater Group
getOUTGROUP {
    out "OUTGROUP? \$1;*OPC?";
    in "%d;1";
}

setOUTGROUP {
    out "OUTGROUP \$1,%d;*OPC?";
    in "1";
    @init { getOUTGROUP; }
}

# Heater Setup
getHTRSET {
    out "HTRSET? \$1;*OPC?";
    in "%d,%(\$2_MXOUT_RBV)f,%(\$2_CURPWR_RBV)d;1";
    @init {
        out "HTRSET? \$1;*OPC?";
        in "%(\$2_RES)d,%(\$2_MXOUT)f,%(\$2_CURPWR.RVAL)d;1";
    }
}

setHTRSET_RES    { out "HTRSET \$1,%d,%(\$2_MXOUT_RBV)f,%(\$2_CURPWR_RBV.RVAL)d;*OPC?"; in "1"; }
setHTRSET_MXOUT  { out "HTRSET \$1,%(\$2_RES_RBV)d,%f,%(\$2_CURPWR_RBV.RVAL)d;*OPC?";   in "1"; }
setHTRSET_CURPWR { out "HTRSET \$1,%(\$2_RES_RBV)d,%(\$2_MXOUT_RBV)f,%d;*OPC?";         in "1"; }

getHTRLIM {
    out "HTRLIM? \$1;*OPC?";
    in "%d,%(\$2_SHRT_RBV)f,%(\$2_OPN_RBV)f;1";
    @init {
        out "HTRLIM? \$1;*OPC?";
        in "%(\$2_EN)d,%(\$2_SHRT)f,%(\$2_OPN)f;1";
    }
}

setHTRLIM_EN   { out "HTRLIM \$1,%d,%(\$2_SHRT_RBV)f,%(\$2_OPN_RBV)f;*OPC?"; in "1"; }
setHTRLIM_SHRT { out "HTRLIM \$1,%(\$2_EN_RBV)d,%f,%(\$2_OPN_RBV)f;*OPC?";   in "1"; }
setHTRLIM_OPN  { out "HTRLIM \$1,%(\$2_EN_RBV)d,%(\$2_SHRT_RBV)f,%f;*OPC?";  in "1"; }

# Heater Autorange
getHTRAUTO {
    out "HTRAUTO? \$1;*OPC?";
    in "%d;1";
}

setHTRAUTO {
    out "HTRAUTO \$1,%d;*OPC?";
    in "1";
    @init { getHTRAUTO; }
}

# Heater Output
getHTROUT {
    out "HTROUT? \$1;*OPC?";
    in "%f,%(\$2_PWR_RBV)f;1";
}

# Monitor Out Parameter
getANALOG {
    out "ANALOG? \$1;*OPC?";
    in "%f,%(\$2_LOW_RBV)f;1";
    @init {
        out "ANALOG? \$1;*OPC?";
        in "%(\$2_HIGH)f,%(\$2_LOW)f;1";
    }
}

setANALOG_HIGH { out "ANALOG \$1,%f,%(\$2_LOW_RBV)f;*OPC?";  in "1"; }
setANALOG_LOW  { out "ANALOG \$1,%(\$2_HIGH_RBV)f,%f;*OPC?"; in "1"; }

# Output Stability
getOUTSTABLE {
    out "OUTSTABLE? \$1;*OPC?";
    in "%d,%(\$2_SETPERR_RBV)f,%(\$2_STLTIM_RBV)d,%(\$2_LATCH_RBV)d,%(\$2_AUD_RBV)d,%(\$2_VIS_RBV)d;1";
    @init {
        out "OUTSTABLE? \$1;*OPC?";
        in "%(\$2_EN)d,%(\$2_SETPERR)f,%(\$2_STLTIM)d,%(\$2_LATCH)d,%(\$2_AUD)d,%(\$2_VIS)d;1";
    }
}

setOUTSTABLE_EN      { out "OUTSTABLE \$1,%d,%(\$2_SETPERR_RBV)f,%(\$2_STLTIM_RBV)d,%(\$2_LATCH_RBV)d,%(\$2_AUD_RBV)d,%(\$2_VIS_RBV)d;*OPC?"; in "1"; }
setOUTSTABLE_SETPERR { out "OUTSTABLE \$1,%(\$2_EN_RBV)d,%f,%(\$2_STLTIM_RBV)d,%(\$2_LATCH_RBV)d,%(\$2_AUD_RBV)d,%(\$2_VIS_RBV)d;*OPC?";      in "1"; }
setOUTSTABLE_STLTIM  { out "OUTSTABLE \$1,%(\$2_EN_RBV)d,%(\$2_SETPERR_RBV)f,%d,%(\$2_LATCH_RBV)d,%(\$2_AUD_RBV)d,%(\$2_VIS_RBV)d;*OPC?";     in "1"; }
setOUTSTABLE_LATCH   { out "OUTSTABLE \$1,%(\$2_EN_RBV)d,%(\$2_SETPERR_RBV)f,%(\$2_STLTIM_RBV)d,%d,%(\$2_AUD_RBV)d,%(\$2_VIS_RBV)d;*OPC?";    in "1"; }
setOUTSTABLE_AUD     { out "OUTSTABLE \$1,%(\$2_EN_RBV)d,%(\$2_SETPERR_RBV)f,%(\$2_STLTIM_RBV)d,%(\$2_LATCH_RBV)d,%d,%(\$2_VIS_RBV)d;*OPC?";  in "1"; }
setOUTSTABLE_VIS     { out "OUTSTABLE \$1,%(\$2_EN_RBV)d,%(\$2_SETPERR_RBV)f,%(\$2_STLTIM_RBV)d,%(\$2_LATCH_RBV)d,%(\$2_AUD_RBV)d,%d;*OPC?";  in "1"; }

# Warmup
cmdWARM {
    out "WARM %(\$1:TEMP)f,%(\$1:PCT)f;*OPC?";
    in "1";
}

# Status Registers
getESE { out "*ESE?;*OPC?";   in "%d;1"; }
setESE { out "*ESE %d;*OPC?"; in "1";    @init { getESE; } }
getESR { out "*ESR?;*OPC?";   in "%d;1"; }

getSRE { out "*SRE?;*OPC?";   in "%d;1"; }
setSRE { out "*SRE %d;*OPC?"; in "1";    @init { getSRE; } }
getSTB { out "*STB?;*OPC?";   in "%d;1"; }

cmdCLS { out "*CLS;*OPC?";    in "1";    }

# Zone
getZONE {
    out "ZONE? \$1,\$2;*OPC?";
    in "%f,%(\$3:P_RBV)f,%(\$3:I_RBV)f,%(\$3:D_RBV)f,%(\$3:MOUT_RBV)f,%(\$3:RANGE_RBV)d,%(\$3:INPUT_RBV)[^,],%(\$3:RATE_RBV)f;1";
    @init {
        out "ZONE? \$1,\$2;*OPC?";
        in "%(\$3:UB)f,%(\$3:P)f,%(\$3:I)f,%(\$3:D)f,%(\$3:MOUT)f,%(\$3:RANGE)d,%(\$3:INPUT)[^,],%(\$3:RATE)f;1";
    }
}

setZONEUB    { out "%f,%(\$3:P_RBV)f,%(\$3:I_RBV)f,%(\$3:D_RBV)f,%(\$3:MOUT_RBV)f,%(\$3:RANGE_RBV.RVAL)d,%(\$3:INPUT_RBV)s,%(\$3:RATE_RBV)f;*OPC?"; in "1"; }
setZONEP     { out "%(\$3:UB_RBV)f,%f,%(\$3:I_RBV)f,%(\$3:D_RBV)f,%(\$3:MOUT_RBV)f,%(\$3:RANGE_RBV.RVAL)d,%(\$3:INPUT_RBV)s,%(\$3:RATE_RBV)f;*OPC?"; in "1"; }
setZONEI     { out "%(\$3:UB_RBV)f,%(\$3:P_RBV)f,%f,%(\$3:D_RBV)f,%(\$3:MOUT_RBV)f,%(\$3:RANGE_RBV.RVAL)d,%(\$3:INPUT_RBV)s,%(\$3:RATE_RBV)f;*OPC?"; in "1"; }
setZONED     { out "%(\$3:UB_RBV)f,%(\$3:P_RBV)f,%(\$3:I_RBV)f,%f,%(\$3:MOUT_RBV)f,%(\$3:RANGE_RBV.RVAL)d,%(\$3:INPUT_RBV)s,%(\$3:RATE_RBV)f;*OPC?"; in "1"; }
setZONEMOUT  { out "%(\$3:UB_RBV)f,%(\$3:P_RBV)f,%(\$3:I_RBV)f,%(\$3:D_RBV)f,%f,%(\$3:RANGE_RBV.RVAL)d,%(\$3:INPUT_RBV)s,%(\$3:RATE_RBV)f;*OPC?"; in "1"; }
setZONERANGE { out "%(\$3:UB_RBV)f,%(\$3:P_RBV)f,%(\$3:I_RBV)f,%(\$3:D_RBV)f,%(\$3:MOUT_RBV)f,%d,%(\$3:INPUT_RBV)s,%(\$3:RATE_RBV)f;*OPC?"; in "1"; }
setZONEINPUT { out "%(\$3:UB_RBV)f,%(\$3:P_RBV)f,%(\$3:I_RBV)f,%(\$3:D_RBV)f,%(\$3:MOUT_RBV)f,%(\$3:RANGE_RBV.RVAL)d,%s,%(\$3:RATE_RBV)f;*OPC?"; in "1"; }
setZONERATE  { out "%(\$3:UB_RBV)f,%(\$3:P_RBV)f,%(\$3:I_RBV)f,%(\$3:D_RBV)f,%(\$3:MOUT_RBV)f,%(\$3:RANGE_RBV.RVAL)d,%(\$3:INPUT_RBV)s,%f;*OPC?"; in "1"; }
